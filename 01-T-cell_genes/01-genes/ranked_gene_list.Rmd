---
title: "gene_expression"
output: 
  pdf_document:
      keep_md: TRUE
---

```{r setup, include=FALSE}
library(data.table)
library(tidyverse)
library(pheatmap)
library(tidytext)
#library(enrichR)
options(scipen=999)

# Read in the median expression for each gene by cell subtype
ranked_pc_filtered <- fread('/projects/nknoetze_prj/ocr_prj/data/processed/gene_lists/ranked_gene_list_missingocrgenes_removedv2.tsv')

types <- c('protein_coding','TR_C_gene','IG_C_gene')
gencode <- fread('/projects/nknoetze_prj/references/annotations/gencode/gencode.v19.transc.type.1based.tsv') %>%
  filter(type=='transcript',gene_type %in% types) %>% select(gene_id,gene_name) %>% unique()

```{r expr_heatmap,fig_width=16.5,fig_height=11}
#Top 22
top_22 <- ranked_pc_filtered %>% select(-osum,-orank,-trank,-t_o_rank,-gene_id,-tsum) %>% head(n=22) %>% mutate(set='Top 22 Genes')
bottom_22 <- ranked_pc_filtered %>% select(-osum,-orank,-trank,-t_o_rank,-gene_id,-tsum) %>% tail(n=22) %>% mutate(set='Bottom 10 Genes')
top22_bottom22 <- rbind(top_22,bottom_22)

top22_bottom22_matrix <- top22_bottom22 %>% select(-gene_group,-row,-set) %>% melt() %>% 
    mutate(variable=gsub("_n_"," ",variable),
           variable=gsub("_"," ",variable),
           variable=str_to_title(variable)) %>% 
  pivot_wider(names_from=variable, values_from=value) %>% column_to_rownames(var='gene_name') 

top22_bottom22_scaledrows <- scale_rows(top22_bottom22_matrix)

paletteLength <- 15
myColor <- colorRampPalette(c("#2166ac","#FBFEF9","#b2182b"))(paletteLength)
# length(breaks) == length(paletteLength) + 1
# use floor and ceiling to deal with even/odd length pallettelengths
myBreaks <- c(seq(min(top22_bottom22_scaledrows), 0, length.out=ceiling(paletteLength/2) + 1), 
              seq(max(top22_bottom22_scaledrows)/paletteLength, max(top22_bottom22_scaledrows), length.out=floor(paletteLength/2)))

row_annotation <- data.frame(`Gene Group`= rep(c("Top-Ranked T-cell Gene", "Bottom Ranked T-cell Gene"), each = 22)) %>% rename("Gene Group"=`Gene.Group`)
rownames(row_annotation) <- rownames(top22_bottom22_scaledrows)

my_colours <-  list(`Gene Group` = c(`Top-Ranked T-cell Gene` = "violetred4", `Bottom Ranked T-cell Gene` = 'grey90'))
# Plot the heatmap
pheatmap(top22_bottom22_scaledrows, color=myColor, breaks=myBreaks,
         show_rownames = TRUE,cluster_rows = FALSE,
         #main="Gene Expression of T-cell Specific Genes Across Cell Types",
         fontsize_col = 10,fontsize_row=9,fontsize = 12,clustering_method = 'ward',cutree_cols = 2,gaps_row = 22,angle_col = 90,
         annotation_row = row_annotation,
         annotation_colors = my_colours)

```
